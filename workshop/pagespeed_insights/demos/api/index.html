<!DOCTYPE html>
<html lang="en">
  <!--
  @license Copyright 2023 Google Inc. All Rights Reserved.

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.

  Author: mbordihn@google.com (Markus Bordihn)
-->
  <head>
    <title>PageSpeed Insights API demo</title>
  </head>
  <body>
    <h1>PageSpeed Insights API demo</h1>
    <p>Please wait page is loading ...</p>
    <script>
      function run() {
        console.log('Getting PageSpeed Insights Data ...');
        const url = setUpQuery();
        fetch(url)
          .then((response) => response.json())
          .then((json) => {
            // See https://developers.google.com/speed/docs/insights/v5/reference/pagespeedapi/runpagespeed#response
            // to learn more about each of the properties in the response object.
            console.log('Received data:', json);
            showInitialContent(json.id);
            const cruxMetrics = {
              'First Contentful Paint':
                json.loadingExperience.metrics.FIRST_CONTENTFUL_PAINT_MS
                  .category,
              'First Input Delay':
                json.loadingExperience.metrics.FIRST_INPUT_DELAY_MS.category,
            };
            showCruxContent(cruxMetrics);
            const lighthouse = json.lighthouseResult;
            const lighthouseMetrics = {
              'First Contentful Paint':
                lighthouse.audits['first-contentful-paint'].displayValue,
              'Speed Index': lighthouse.audits['speed-index'].displayValue,
              'Time To Interactive':
                lighthouse.audits['interactive'].displayValue,
              'First Meaningful Paint':
                lighthouse.audits['first-meaningful-paint'].displayValue,
            };
            showLighthouseContent(lighthouseMetrics);
            showOriginLoadingExperience(json.originLoadingExperience.metrics);
          });
      }

      function setUpQuery() {
        const api =
          'https://www.googleapis.com/pagespeedonline/v5/runPagespeed';
        const parameters = {
          url: encodeURIComponent('https://developers.google.com'),
        };
        let query = `${api}?`;
        for (key in parameters) {
          query += `${key}=${parameters[key]}`;
        }
        return query;
      }

      function showInitialContent(id) {
        document.body.innerHTML = '';
        const title = document.createElement('h1');
        title.textContent = 'PageSpeed Insights API Demo';
        document.body.appendChild(title);
        const page = document.createElement('p');
        page.textContent = `Page tested: ${id}`;
        document.body.appendChild(page);
      }

      function showCruxContent(cruxMetrics) {
        const cruxHeader = document.createElement('h2');
        cruxHeader.textContent = 'Chrome User Experience Report Results';
        document.body.appendChild(cruxHeader);
        for (key in cruxMetrics) {
          const p = document.createElement('p');
          p.textContent = `${key}: ${cruxMetrics[key]}`;
          document.body.appendChild(p);
        }
      }

      function showLighthouseContent(lighthouseMetrics) {
        const lighthouseHeader = document.createElement('h2');
        lighthouseHeader.textContent = 'Lighthouse Results';
        document.body.appendChild(lighthouseHeader);
        for (key in lighthouseMetrics) {
          const p = document.createElement('p');
          p.textContent = `${key}: ${lighthouseMetrics[key]}`;
          document.body.appendChild(p);
        }
      }

      function showOriginLoadingExperience(metrics) {
        const header = document.createElement('h2');
        header.textContent = 'Origin Loading Experience';
        document.body.appendChild(header);
        for (key in metrics) {
          const p = document.createElement('p');
          p.textContent = `${key}: ${metrics[key].category}`;
          document.body.appendChild(p);
        }
      }

      run();
    </script>
  </body>
</html>
